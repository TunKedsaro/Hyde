# Dockerfile.dev (Jupyterlab)
FROM python:3.12-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

RUN apt-get update && apt-get install -y \
    tree \
    vim \
    curl \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

EXPOSE 8888


# Dockerfile.dev (FastAPI)
FROM python:3.12-slim

RUN apt-get update && apt-get install -y apt-transport-https ca-certificates gnupg curl

RUN curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg

RUN echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list

RUN apt-get update && apt-get install -y git vim net-tools build-essential google-cloud-cli=473.0.0-0

WORKDIR /code

ENV PYTHONPATH=/code/src

# Docker command
docker build -f Dockerfile.dev -t hyde .

docker run -it --name hyde-dev -p 4000:4000 -v %cd%:/code hyde bash

# start jupyter server
jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root

# start FastAPI server


# GCLOUD
gcloud --version

gcloud init
 [56] poc-piloturl-nonprod
 [30] asia-southeast1-a

gcloud artifacts repositories create hyderecomment \
  --repository-format=docker \
  --project=poc-piloturl-nonprod \
  --location=asia-southeast1

gcloud builds submit \
  --config=cloudbuild.yaml \
  --project=poc-piloturl-nonprod

gcloud run deploy hyderecomment-service-v1 \
  --image="asia-southeast1-docker.pkg.dev/poc-piloturl-nonprod/hyderecomment/hyderecomment:latest" \
  --region="asia-southeast1" \
  --port=4000 \
  --memory=2Gi \
  --cpu=2 \
  --max-instances=5 \
  --set-env-vars="APP_ENV=prod,GOOGLE_API_KEY=AIza...UIAA" \
  --allow-unauthenticated

